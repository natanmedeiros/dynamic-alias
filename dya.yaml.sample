# Rules: @system_rules.txt
---
type: dict
name: database_servers
data:
  - name: db1
    host: databasehost1
    port: 5432
    user: $${env.DB_USER}
    dbname: test
  - name: db2
    host: databasehost2
    port: 5432
    user: $${env.DB_USER}
    dbname: test
  - name: db3
    host: databasehost3
    port: 5432
    user: $${env.DB_USER}
    dbname: test

---
type: dynamic_dict
name: redis_servers
priority: 1
command: |
  aws elasticache describe-cache-clusters \
    --query "CacheClusters[?Engine=='redis'].{name:CacheClusterId, host:CacheNodes[0].Endpoint.Address, port:CacheNodes[0].Endpoint.Port}" \
    --output json
mapping:
  name: name
  host: host
  port: port

---
type: dict
name: application_servers
data:
  - name: app1
    host: app1host
    port: 8080
    user: admin
    dbname: test
  - name: app2
    host: app2host
    port: 8080
    user: admin
    dbname: test

---
type: command
name: s3 sync
alias: sync ${source} ${destination}
command: aws s3 sync --profile abc ${source} ${destination}
helper: |
  Description:
    Syncs files with AWS S3 bucket
  Usage:
    minha_cli sync ${source} ${destination}

---
type: command
name: application health check
alias: check $${application_servers.name}
command: curl http://$${application_servers.host}:$${application_servers.port}/health
helper: |
  Description:
    Calls curl at health check endpoint
  Usage:
    minha_cli check application_servers.name

---
type: command
name: PostgreSQL
alias: pg $${database_servers.name}
command: psql -h $${database_servers.host} -p $${database_servers.port} -U $${database_servers.user} -d $${database_servers.dbname}
helper: |
  Description:
    Calls psql with possibility of execution of sql file or sql text
  Usage:
    minha_cli pg database_servers.name [option]
  Options:
    file ${filename}
    cmd ${sql_text}
args:
  - alias: -o ${output_filename}
    command: -o ${output_filename}
    helper: |
      Description:
        Outputs to a file
      Usage:
        minha_cli pg database_servers.name -o output_filename
  - alias: -v
    command: -v
    helper: |
      Description:
        Verbose mode
      Usage:
        minha_cli pg database_servers.name -v
sub:
  - alias: file ${filename}
    command: -f ${filename}
    helper: |
      Description:
        Executes a sql file
      Usage:
        minha_cli pg database_servers.name file filename
  - alias: cmd ${sql_text}
    command: -c "${sql_text}"
    helper: |
      Description:
        Executes a sql text
      Usage:
        minha_cli pg database_servers.name cmd sql_text

---
type: command
name: Redis
alias: rd $${redis_servers.name}
command: redis-cli -h $${redis_servers.host} -p $${redis_servers.port}
helper: |
  Description:
    Calls redis-cli with possibility of execution of script
  Usage:
    minha_cli rd redis_servers.name [script]
  Options:
    ${script}
sub:
  - alias: ${script}
    command: ${script}
    helper: |
      Description:
        Executes a script
      Usage:
        minha_cli rd redis_servers.name script